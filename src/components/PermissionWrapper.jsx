import React from 'react';
import { Navigate } from 'react-router-dom';
import { useFastAuth } from '../hooks/useFastAuth';
import { canAccessPage, getPermissionMessage } from '../utils/permissions';

/**
 * Higher-Order Component ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤
 * @param {React.Component} WrappedComponent - Component ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
 * @param {string} requiredPage - ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
 * @param {Object} options - ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
 */
export const withPermission = (WrappedComponent, requiredPage, options = {}) => {
  const {
    redirectTo = '/login',
    showMessage = true,
    fallbackComponent: FallbackComponent = null
  } = options;

  return function ProtectedComponent(props) {
    const { user, isLoading } = useFastAuth();

    // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    if (isLoading) {
      return (
        <div className="permission-loading">
          <div className="loading">
            <div className="spinner"></div>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...
          </div>
        </div>
      );
    }

    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - redirect ‡πÑ‡∏õ login
    if (!user) {
      return <Navigate to={redirectTo} replace />;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    const hasAccess = canAccessPage(user, requiredPage);

    if (!hasAccess) {
      // ‡πÅ‡∏™‡∏î‡∏á Fallback Component ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (FallbackComponent) {
        return <FallbackComponent user={user} requiredPage={requiredPage} />;
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      if (showMessage) {
        return (
          <div className="permission-denied">
            <div className="permission-denied-container">
              <div className="permission-denied-icon">üö´</div>
              <h2>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2>
              <p>{getPermissionMessage(user.role, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')}</p>
              <div className="permission-actions">
                <button 
                  onClick={() => window.history.back()} 
                  className="btn-back"
                >
                  ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                </button>
                <button 
                  onClick={() => window.location.href = '/'} 
                  className="btn-home"
                >
                  ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Redirect ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      return <Navigate to="/" replace />;
    }

    // ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå - ‡πÅ‡∏™‡∏î‡∏á Component
    return <WrappedComponent {...props} user={user} />;
  };
};

/**
 * Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
 * @param {string} permission - ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
 * @returns {Object}
 */
export const usePermission = (permission) => {
  const { user, isLoading } = useFastAuth();

  const hasPermission = React.useMemo(() => {
    if (!user || isLoading) return false;
    
    if (typeof permission === 'string') {
      return canAccessPage(user, permission);
    }
    
    return false;
  }, [user, isLoading, permission]);

  return {
    hasPermission,
    user,
    isLoading,
    role: user?.role,
    isAdmin: user?.admin || user?.role === 'admin'
  };
};

/**
 * Component ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô UI ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
 */
export const PermissionGate = ({ 
  permission, 
  children, 
  fallback = null,
  user: propUser = null 
}) => {
  const { user: hookUser } = useFastAuth();
  const user = propUser || hookUser;

  if (!user) {
    return fallback;
  }

  const hasAccess = canAccessPage(user, permission);

  return hasAccess ? children : fallback;
};

/**
 * Component ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
 */
export const PermissionDenied = ({ user, requiredPage, onBack, onHome }) => {
  return (
    <div className="permission-denied">
      <div className="permission-denied-container">
        <div className="permission-denied-icon">üö´</div>
        <h2>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2>
        <p>{getPermissionMessage(user?.role, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')}</p>
        <div className="permission-denied-info">
          <p>‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
          <p>‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
        <div className="permission-actions">
          <button 
            onClick={onBack || (() => window.history.back())} 
            className="btn-back"
          >
            ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
          </button>
          <button 
            onClick={onHome || (() => window.location.href = '/')} 
            className="btn-home"
          >
            ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
          </button>
        </div>
      </div>
    </div>
  );
};
